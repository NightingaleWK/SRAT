# 1. 工具介绍
SRAT 是 Server Resource Acquisition Tool 的英文缩写，中文名是“服务器资源获取工具”，这套工具是我运维工作中用来巡检服务器的，获取服务器关键参数，并利用这些数据来制作我的巡检报告。

之前巡检服务器得每一台都登上去看，一个一个的检查 cpu、内存、硬盘空余等相关信息，非常麻烦，碰见服务器多的项目，一趟下来服务器多的项目得 4 小时。

于是我找了点时间，自己写了这个工具。利用这套工具，几分钟就获得我们想要的数据，非常的方便 😀

# 2. 原理介绍
## 2.1 假设服务器概览
假设 33 台服务器分为 13 台 windows 服务器和 20 台 linux 服务器，我们用 2 个脚本对这 2 个类型的系统进行分别的自动化巡检

## 2.2 Windows 服务器自动巡检技术介绍
Windows 主机我们使用的技术是自带的 WinRM 服务。全部主机均开启 WinRM 服务，并对每台巡检端配置仅监听并执行 34 主机的可信名单，34 主机则对某网段下的所有主机可信，前者是为了防止各主机之间存在横向渗透的安全风险，后者的目的是为了让 36 主机访问到其他几台服务器。

我们将 34 主机作为收集端，2、3、4、5、6、10、11、12、13、33、35、36 作为巡检端，同时 34 再对自己进行自巡检，收集端对本机进行巡检并输出结果到收集端，一台一台主机的轮询，最终结果文件会生成在收集端。这就意味着实际执行巡检工作的是每个巡检端主机，且脚本放在巡检端，收集端的作用是远程启动各个巡检端的脚本，并收集数据

脚本语言选择的是 powershell 脚本，通过编写相关代码实现对本机资源的查询。

Windows 下的结果文件有两个， 分别为 “win_sysInfo_calculation_2022_12_07_16_24_29.txt” 和 “win_sysInfo_humanization_2022_12_07_16_24_29.txt”。前者是用于放入 Excel 中进行数据分析和数据整理的。后者是将结果文件整理为一份人类便于阅读的文档。这两种文件的内容都是一致的，都具有参考性。

# 2.3 Linux 服务器自动巡检技术介绍
Linux 主机的彼此通讯使用 ssh 协议进行，实际执行的时候使用 sshpass 服务来实现免密登录并执行相关代码，其本质就是通过 ssh 协议远程执行代码指令。

我们将 31 主机作为收集端，8、9、14、15、16、17、18、19、20、21、22、23、24、25、26、27、28、29、30 作为巡检端，通知 31 再对自己进行自巡检，收集端对本机进行巡检并输出结果到收集端，一台一台主机的轮询，最终结果文件会生成在收集端。

与 win 有所不同的是，各巡检端服务器均不存放任何脚本文件，所有指令均编写到 31 服务器的 shell 脚本文件内，通过 ssh 协议远程发送各类执行代码，获取控制台数据，最终存在收集端。这么做的原因是因为 linux 对命令行的原生支持远优于 win ，win 下做不到对远端主机执行 ps1 脚本文件，仅可通过 winrs 指令执行简单的命令，而 ssh 可以使用大量原生的、客制化的指令，只要能 ssh 连接到远端，就可以批量、有序、无人值守的执行客制化的代码，说实话，Linux 的巡检与开发体验真的比 Windows 好太多了。

脚本使用的就是 linux 的原生命令，并写入 shell 文件中，以便批量执行。

# 3. 简明使用指南
就 4 步
```
1. 挂上 VPN （目的是进入主机群组的网路环境）
2. 在 34 机子上，到 C:\inspectionByCestc 中，执行 win_sysInfo_start.ps1
3. 在 31 机子上，到 /root/sh 中，执行 linux_sysInfo_start.sh
然后分别去脚本所在目录下找 result 目录，里面就是结果文件
```

# 4. 详细使用指南 - windows 篇
## 4.1 配置 WinRM 服务
所有 windows 主机均需要开启 WinRM 服务，首先打开管理员模式下的 powershell 终端（之后我们将带有管理员权限的 powershell 终端称之为 ps，方便理解），执行：
```
WinRM QuickConfig
```
系统会自动完成配置，接下来我们对“主机”和“从机”进行配置。“主机”是你汇聚一切数据到一个地方的服务器，“主机”只有一个，剩下的全部是“从机”，首先我们配置“主机”，在 ps 里输入：
```
Set-Item wsman:\localhost\Client\TrustedHosts -value 100.100.100.*
Get-Item WSMan:\localhost\Client\TrustedHosts
```
刚才指令中的 100.100.100.* 指的是我们项目所在的服务器群的网段是 100 网段，这里的目的是“主机”能且只能对 100 网段中的“从机”进行交互。这里根据实际修改网段地址。

然后我们配置“从机”，在每一台服务器上打开 ps，输入：
```
Set-Item wsman:\localhost\Client\TrustedHosts -value '100.100.100.34'
Get-Item WSMan:\localhost\Client\TrustedHosts
```

结合上面同样的指令类型，我们很好理解，这里的目的是让每台“从机”能且只能与 34 服务器进行交互，这样做的目的是防止横向渗透攻击，我们只需要保护住 34 这一台服务器即可。至此我们的 WinRM 服务便完成了配置。

## 4.2 其他准备工作
1. 别急着走，我相信认真负责的你为每台 windows 服务器上配备了安全软件，务必将所有服务器上的脚本的所在目录加入到机子安全软件的白名单中。否则你在 34 上执行后，命令会被杀毒软件拦截，就导致失败。
2. 最后，假若电脑若重启过，需要重新进行 WinRM 配置，按照上述流程重新走一遍就好了。

## 4.3 开始脚本部署
终于来到最麻烦的地方了，相信我，麻烦这一次，受益终生，而且等会玩 linux 那部分的时候就不需要这步的。

我们需要将脚本一台台服务器的复制粘贴上去，具体方式如下：

1. 在每台服务器的 C 盘根目录下新建文件夹 inspectionByCestc，别错了，这跟脚本里的路径对应，错了就完了。
2. 然后将如下 2 个脚本复制进去：
    - ``in_sysInfo_calculation.ps1``
    - ``win_sysInfo_humanization.ps1``
3. 然后我们特殊处理一下 34 这台“主机”，我们将 ``win_sysInfo_start.ps1`` 也放在 ``inspectionByCestc`` 文件夹下，然后继续在 inspectionByCestc 文件夹下，新建文件夹 result，这个 result 用来存放我们的结果文件。

至此，我们就完成了一切准备工作

## 4.4 开始执行
进入到我们的“主机”，假设是 34 服务器，在 ps 中输入：
```
powershell C:\inspectionByCestc\win_sysInfo_start.ps1
```
若提示禁止运行脚本，则需要设置允许执行，在 ps 中输入：
```
set-executionpolicy remotesigned
```
就可以解决这个问题。

若顺利的话，之后 ps 中开始显示进度，最终提示结束后，就可以去之前说的 result 文件夹中收集我们需要的文件了，两个文件哦：

- win_sysInfo_calculation_2022_12_08_14_14_51.txt
- win_sysInfo_humanization_2022_12_08_14_14_51.txt

其中，第一个文件是用于表格计算和填写数据的，第二个是用于整个文件备份存储的。换句话说，第一个用于完成报告，第二个用于存档。而第一个文件我会在后面章节集中讲解如何使用，这里就点一下。

# 5. 详细使用指南 - linux 篇
## 5.1 快速部署脚本
相对于 windows，linux 这里可以说是非常简单，首先还记得我们“主机”和“从机”的概念吗？不知道的话可去上个章节“4. 详细使用指南 - windows 篇”复习一下。

我们到“主机”上，在 root 目录下新建一个名为 sh 的目录，命令为：
```
cd /root
mkdir sh
```
然后我们想办法把我们的脚本放上去，我这里推荐开源免费软件 winscp，我们用它以 ftp 或者 sftp 的方式连接上，把脚本 ``linux_sysInfo_start.sh`` 放到 sh 下，然后赋予其 777 的权限，你用 winscp 在文件里右键修改权限也行，或者用 ``chmod 777 linux_sysInfo_start.sh`` 也行，怎么样都行，不赋予权限是无法执行的。

最后记得在 sh 目录下新建一个 result 目录，用于存放结果文件。

以上新建目录的地方和名字不要错，否则会报错，这些都是脚本里预先指定的参数。

至此，脚本部署完毕。

## 5.2 开始执行
在目录 sh 下执行：
```
./linux_sysInfo_start.sh
```
若顺利的话，之后 ps 中开始显示进度，最终提示结束后，就可以去之前说的 result 文件夹中收集我们需要的文件了，两个文件哦：

1. linux_sysInfo_calculation_2022_12_08_14_14_51.txt
2. linux_sysInfo_humanization_2022_12_08_14_14_51.txt

其中，第一个文件是用于表格计算和填写数据的，第二个是用于整个文件备份存储的。换句话说，第一个用于完成报告，第二个用于存档。而第一个文件我会在后面章节集中讲解如何使用，这里就点一下。

# 6. 数据处理
这章节与脚本就无关了，算是额外送的，普及一下 excel 基本知识。我们一趟操作猛如虎，最终会得到 4 个结果文件，2 个 win 的，2 个 linux 的：
1. win_sysInfo_calculation_2022_12_08_14_14_51.txt
2. win_sysInfo_humanization_2022_12_08_14_14_51.txt
3. linux_sysInfo_calculation_2022_12_08_14_14_51.txt
4. linux_sysInfo_humanization_2022_12_08_14_14_51.txt

文件名中的 calculation 就代表着这个文件是用来做数据分析的，我们等会用这俩，剩下的 humanization 的疑似就是人性化的，这些文件就是既能存放（因为数据全）又能只管的看相关数据（因为我给他排版设计的好看）

接下来我们关注一下带 calculation 关键字的文件：
1. win_sysInfo_calculation_2022_12_08_14_14_51.txt
2. linux_sysInfo_calculation_2022_12_08_14_14_51.txt

我们随意新建并打开一个 excel，选择“数据”-“从文件/CSV”，在弹窗中选择其中一个结果文件，选择“导入”

之后系统会稍作加载，再弹出一个框，这就是 excel 对 txt 文件分析的结果，我们源文件的每个值都是用英文逗号分隔，系统按照这个规则将 txt 文本文件转化为 excel 表格，弹窗内容就是解析效果，我们点击“加载”后表格就会展示到后面。

至此，我们导入了第一个文件，接下来把第二个 txt 文件以同样的步骤导入进来。

然后我们复制一份之前的基础资源巡检表格文件，打开，现在这个基础资源表格我对他进行了调整，这些服务器的排列规则是先按服务器类型排序，然后再按IP从小到大排序。我这样做的目的就是让基础巡检表的服务器排序匹配巡检脚本生成结果文件的排序，完美合拍

然后就是最妙的地方，只需要把cpu、内存、磁盘的脚本结果表格的内容，复制，粘贴到基础资源巡检表上，然后粘贴的时候选择“仅粘贴值”，完美，严丝合缝。

废了九牛二虎之力，终于实现了一键式自动巡检、结果自动汇总、结果文件完美贴合巡检报告。再也不用：
1. 一台台服务器截图、抄参数
2. 一个个数值的复制粘贴到基础资源巡检表
3. 在一种类型的服务器上执行复杂的操作哟

现在 2 个脚本，满足你的巡检需求 😘😘😘
